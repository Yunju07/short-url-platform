version: "3.9"

services:
  # ----------------------------
  # url-service (8081)
  # ----------------------------
  url-service:
    build:
      context: .
      dockerfile: ./url-service/Dockerfile
    container_name: url-service
    image: yunju/url-service:v1.0.0
    ports:
      - "8081:8080"
    env_file:
      - ./compose/app.env
    depends_on:
      db:
        condition: service_healthy
      ollama:
        condition: service_started
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - TZ=Asia/Seoul
    networks:
      - shorturl-net

  # ----------------------------
  # redirect-service (8082)
  # ----------------------------
  redirect-service:
    build:
      context: .
      dockerfile: ./redirect-service/Dockerfile
    container_name: redirect-service
    image: yunju/redirect-service:v1.0.0
    ports:
      - "8082:8080"
    env_file:
      - ./compose/app.env
    depends_on:
      db:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - TZ=Asia/Seoul
    networks:
      - shorturl-net

  # ----------------------------
  # stats-service (8083)
  # ----------------------------
  stats-service:
    build:
      context: .
      dockerfile: ./stats-service/Dockerfile
    container_name: stats-service
    image: yunju/stats-service:v1.0.0
    ports:
      - "8083:8080"
    env_file:
      - ./compose/app.env
    depends_on:
      db:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - TZ=Asia/Seoul
    networks:
      - shorturl-net

  # ----------------------------
  # MySQL
  # ----------------------------
  db:
    image: mysql:8.0
    container_name: shorturl-db
    environment:
      TZ: Asia/Seoul
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: shorturl
      MYSQL_USER: shorturl
      MYSQL_PASSWORD: shorturl
    ports:
      - "3306:3306"
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - shorturl-net
    healthcheck:
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -uroot -proot" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # ----------------------------
  # Redis
  # ----------------------------
  redis:
    image: redis:7
    container_name: shorturl-redis
    command: [
      "redis-server",
      "--appendonly", "yes",
      "--maxmemory", "2gb",
      "--maxmemory-policy", "allkeys-lfu"
    ]
    ports:
      - "6379:6379"
    networks:
      - shorturl-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ----------------------------
  # Ollama (LLM)
  # ----------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: shorturl-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - shorturl-net

  ollama-init:
    image: ollama/ollama:latest
    container_name: shorturl-ollama-init
    depends_on:
      - ollama
    env_file:
      - ./compose/app.env
    entrypoint: ["sh", "-c", "sleep 2 && OLLAMA_HOST=$$LLM_BASE_URL ollama pull $$LLM_MODEL"]
    networks:
      - shorturl-net

  # ----------------------------
  # Zookeeper
  # ----------------------------
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: shorturl-zookeeper
    environment:
      TZ: Asia/Seoul
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_log:/var/lib/zookeeper/log
    networks:
      - shorturl-net

  # ----------------------------
  # Kafka Broker 1
  # ----------------------------
  kafka-1:
    image: confluentinc/cp-kafka:7.6.1
    container_name: shorturl-kafka-1
    depends_on:
      - zookeeper
    ports:
      - "19093:19093"
    environment:
      TZ: Asia/Seoul
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: "shorturl-zookeeper:2181"

      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:19093,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://shorturl-kafka-1:19093,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 6
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server=shorturl-kafka-1:19093" ]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - kafka1_data:/var/lib/kafka/data
    networks:
      - shorturl-net

  # ----------------------------
  # Kafka Broker 2
  # ----------------------------
  kafka-2:
    image: confluentinc/cp-kafka:7.6.1
    container_name: shorturl-kafka-2
    depends_on:
      - zookeeper
    ports:
      - "19094:19094"
    environment:
      TZ: Asia/Seoul
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: "shorturl-zookeeper:2181"

      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:19094,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://shorturl-kafka-2:19094,PLAINTEXT_HOST://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 6
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server=shorturl-kafka-2:19094" ]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - kafka2_data:/var/lib/kafka/data
    networks:
      - shorturl-net

  # ----------------------------
  # Kafka Broker 3
  # ----------------------------
  kafka-3:
    image: confluentinc/cp-kafka:7.6.1
    container_name: shorturl-kafka-3
    depends_on:
      - zookeeper
    ports:
      - "19095:19095"
    environment:
      TZ: Asia/Seoul
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: "shorturl-zookeeper:2181"

      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:19095,PLAINTEXT_HOST://0.0.0.0:9095
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://shorturl-kafka-3:19095,PLAINTEXT_HOST://localhost:9095
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 6
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server=shorturl-kafka-3:19095" ]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - kafka3_data:/var/lib/kafka/data
    networks:
      - shorturl-net

  # ----------------------------
  # Kafka UI
  # ----------------------------
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "9000:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: shorturl-kafka-1:19093,shorturl-kafka-2:19094,shorturl-kafka-3:19095
      KAFKA_CLUSTERS_0_ZOOKEEPER: shorturl-zookeeper:2181
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
    networks:
      - shorturl-net

  # ----------------------------
  # MongoDB
  # ----------------------------
  mongo:
    image: mongo:6.0
    container_name: shorturl-mongo
    restart: always
    ports:
      - "27017:27017"
    environment:
      TZ: Asia/Seoul
      MONGO_INITDB_DATABASE: shorturl
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - mongo_data:/data/db
    networks:
      - shorturl-net

  mongo-express:
    image: mongo-express:latest
    container_name: shorturl-mongo-express
    restart: unless-stopped
    ports:
      - "8090:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: shorturl-mongo
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_MONGODB_ENABLE_ADMIN: false
      ME_CONFIG_BASICAUTH: "false"
    depends_on:
      - mongo
    networks:
      - shorturl-net

networks:
  shorturl-net:

volumes:
  db-data:
  kafka1_data:
  kafka2_data:
  kafka3_data:
  zookeeper_data:
  zookeeper_log:
  mongo_data:
  ollama_data:
